@page "/worktime"
@using AMI.EduWork.Domain.Interfaces.Service
@using AMI.EduWork.Domain.Models.TimeSlice
@using AMI.EduWork.Domain.Models.User
@using AMI.EduWork.Components.Feature.WorkTime.Components
@inject IServiceScopeFactory ServiceScopeFactory
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@attribute [Authorize]

<!-- TOP BAR -->
<MudPaper Class="d-flex align-center justify-space-between" Style="padding:8px;">
    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Add" OnClick="OpenAddDialogAsync">
        Add slice manually
    </MudButton>
    <div class="d-flex align-center">
        <MudText Typo="Typo.h6" Class="mr-2" Style="font-family:monospace;">
            00:00:00
        </MudText>
        <MudIconButton Icon="@Icons.Material.Filled.PlayArrow" Color="Color.Primary" Size="Size.Large" OnClick="StartTimer" />
    </div>
</MudPaper>


<!-- DATE NAVIGATION BAR -->
<MudPaper Class="d-flex align-center justify-space-between" Style="background-color:slategrey; padding:8px;">
    <div style="width: 180px;"></div>
    <div class="d-flex align-center" style="gap: 8px;">
        <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" Color="Color.Inherit" OnClick="PreviousDate" />
        <MudText Typo="Typo.h6" Style="font-weight:bold; color:white;">
            @currentDate?.ToString("dd.MM.yyyy")
        </MudText>
        <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" Color="Color.Inherit" OnClick="NextDate" />
    </div>
    <div style="flex: 0 0 auto;">
        <MudDatePicker Date="@currentDate"
                       DateChanged="OnDateChanged"
                       DateFormat="dd.MM.yyyy" 
                       Style="font-weight:bold; color:white;" />
    </div>
</MudPaper>

<!-- MAIN CONTENT -->
<MudGrid Class="mt-4" Style="height:400px;">
    <MudItem xs="12" md="8">
        <MudContainer>
            <MudGrid Spacing="2">
                @if (timeslices != null)
                {
                    @foreach (var timeslice in timeslices)
                    {
                        <MudItem xs="12">
                            <TimeSliceCard TimeSlice="timeslice" OnEditRequested="OpenUpdateDialog" />
                        </MudItem>
                    }
                }
            </MudGrid>
        </MudContainer>
    </MudItem>
    
    <MudItem xs="12" md="4">
        <MudPaper Class="pa-4" Style="height:100%; background-color:#444444; color:white;">
            <!-- TODO statistics -->
        </MudPaper>
    </MudItem>
</MudGrid>


@code {
    private DateTime? currentDate = DateTime.Today;
    public DateTime nonNullableDate => currentDate ?? DateTime.Today;
    private List<GetTimeSliceModel> timeslices;
    private string firstUser;

    protected override async Task OnInitializedAsync()
    {
        await LoadFirstUser();
        await GetAllUserTimeSlicesByDate();
    }

    private async Task LoadFirstUser()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        firstUser = user.FindFirst(ClaimTypes.NameIdentifier)?.Value
                  ?? user.FindFirst("sub")?.Value
                  ?? string.Empty;
    }

    protected async Task GetAllUserTimeSlicesByDate()
    {
        if (firstUser == null) return;
        using var scope = ServiceScopeFactory.CreateScope();
        var _timeSliceService = scope.ServiceProvider.GetRequiredService<ITimeSliceService>();
        var result = await _timeSliceService.GetAllUserTimeSlicesByDate(firstUser, nonNullableDate);
        timeslices = result?.ToList() ?? new List<GetTimeSliceModel>();
    }

    private Task OpenAddDialogAsync()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };

        var parameters = new DialogParameters { ["Date"] = nonNullableDate }; 
        return DialogService.ShowAsync<AddTimeSlice>("Add Time Slice", parameters);
    }

    private async Task OnDateChanged(DateTime? newDate)
    {
        currentDate = newDate;
        await GetAllUserTimeSlicesByDate();
    }

    private async Task PreviousDate()
    {
        currentDate = currentDate?.AddDays(-1);
        await GetAllUserTimeSlicesByDate();
    }

    private async Task NextDate()
    {
        currentDate = currentDate?.AddDays(1);
        await GetAllUserTimeSlicesByDate();
    }

    private void StartTimer()
    {
        // TODO
    }

    private async Task OpenUpdateDialog(GetTimeSliceModel timeSlice)
    {
        var parameters = new DialogParameters { ["TimeSlice"] = timeSlice };
        await DialogService.ShowAsync<UpdateTimeSlice>("Update Time Slice", parameters);
    }
}
